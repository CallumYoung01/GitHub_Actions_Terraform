name: 'Terraform Deploy'
description: 'Deploys the Terraform'
inputs:
  ARM_TENANT_ID:
    description: 'Azure Tenant ID'
    required: false
  environment:
    description: 'Deployment environment'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Setup Terraform
      id: TF-Setup
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Validate
      id: validate
      if: github.ref == 'refs/heads/main'
      shell: bash
      run: |
        terraform init -backend-config="./backend/${{ inputs.environment }}-backend.hcl"
        terraform validate
      env:
        TF_VAR_serviceprinciple_key: ${{ secrets.TERRAFORM_CLIENT_SECRET }}
        TF_VAR_environment: ${{ inputs.environment }}
        TF_VAR_subscription_id: ${{ secrets.TERRAFORM_SUBSCRIPTION_ID }}

    - name: Terraform Plan
      shell: bash
      run: |
        terraform init -backend-config="./backend/${{ inputs.environment }}-backend.hcl"
        terraform plan -var-file="config/common.tfvars" -var-file="config/${{ inputs.environment }}.tfvars"
      env:
        TF_VAR_environment: ${{ inputs.environment }}
        TF_VAR_subscription_id: ${{ secrets.TERRAFORM_SUBSCRIPTION_ID }}

    - name: Terraform Apply
      shell: bash
      if: ${{ github.event.inputs.runApply == 'true' }}
      run: |
        terraform init -backend-config="./backend/${{ inputs.environment }}-backend.hcl"
        terraform apply -var-file="config/common.tfvars" -var-file="config/${{ inputs.environment }}.tfvars" -auto-approve -input=false
      env:
        TF_VAR_environment: ${{ inputs.environment }}
        TF_VAR_subscription_id: ${{ secrets.TERRAFORM_SUBSCRIPTION_ID }}
